# CLAUDE.md

## Toolchain

- **Runtime & package manager**: `bun` and `bunx` — NEVER use `npm`, `npx`, `yarn`, or `node`
- **Type checking**: `bunx tsgo` — NEVER use `tsc`
- **Linting**: `bunx oxlint` — NEVER use `eslint`
- **Testing**: `bun test`

## Code Quality

Every implementation (feature, fix, test, refactor) must be reviewed and validated for:

- **Performance** — no unnecessary allocations, O(n) over O(n*k), avoid redundant computations
- **Genericity** — reusable patterns, no hardcoded values that should be configurable, single source of truth
- **Conciseness** — minimal code to achieve the goal, no dead code, no over-engineering, no premature abstractions

## Audit

- `AUDIT.md` tracks code review findings — remove entries once fixed, file should be empty when all issues are resolved

## Testing

### Folder Structure
```
tests/
├── unit/           # Pure function tests (no external deps)
├── isolated/       # Tests using mock.module (process-global isolation)
├── integration/    # External contract tests (APIs, on-chain, Redis)
├── e2e/            # End-to-end flows (full system)
└── helpers.ts      # Shared test utilities
```

### Unit Tests (`tests/unit/*.test.ts`)
- Test **exported functions** only — never reimplement logic inline
- Every `expect()` must assert a **property of the system under test**, not a JS built-in
- Test names must match assertions — if the name claims a comparison, the test MUST assert it
- No `expect(true).toBe(true)` or other tautologies
- Use `beforeEach` for mock reset; prefer `beforeEach`/`afterEach` over inline try/finally for mock lifecycle
- Mock only I/O boundaries (fetch, DB, Redis, RPC) — never mock pure functions

### Integration Tests (`tests/integration/*.test.ts`)
- Test real external contracts (APIs, on-chain, Redis) — skip gracefully when unavailable
- No arithmetic re-derivation of application logic — call the real functions
- `console.log` acceptable for diagnostic output

### Isolated Tests (`tests/isolated/*.isolated.ts`)
- Required when using `mock.module` (bun process-global contamination)
- Run via `Bun.spawn` in a wrapper test file (`*.test.ts`)
- Share mock reset logic via a single `resetMocks()` function — no duplicated `beforeEach` blocks

### E2E Tests (`tests/e2e/*.test.ts`)
- Full system flow tests (data fetch → decision → execution)
- Minimal mocking, real in-memory DB, real calculations
- Higher timeout values acceptable

### General Rules
- `bun test` is the only test runner — NEVER jest/vitest/mocha
- No smoke tests that only verify "no throw" — assert observable outcomes
- No tests of JS/TS language features (Array.map, Number precision, etc.)
- Fragile mocks (call-count parity, timing assumptions) are banned — use deterministic state
- Helpers go in `tests/helpers.ts` — no duplicated setup across files

## Commit & Branch Conventions

See [CONTRIBUTING.md](./CONTRIBUTING.md) for:
- Commit message format (`<type>(scope): <subject>`)
- Branch naming (`feat/`, `fix/`, `refactor/`, etc.)
- PR workflow

**Critical rule:** Never mention AI co-authorship (Co-Authored-By, "generated by", etc.) in commit messages, docs, comments, or any project artifacts
